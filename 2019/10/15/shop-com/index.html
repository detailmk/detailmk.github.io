<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-mac-osx.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="coder--编写代码,制造魔法" type="application/atom+xml">






<meta name="description" content="title:基于ssm的电商系统date: 2019-10-15 09:22:09tags: [“java框架”]categories: ssm 基于ssm的电商系统[TOC] 环境搭建** maven 多模块 聚合  ego-parent(pom) ​    ego-common(jar，公共类、枚举、工具类) ego-manager(pom，管理员管理系统) ​    ego-manager-">
<meta property="og:type" content="article">
<meta property="og:title" content="coder--编写代码,制造魔法">
<meta property="og:url" content="https://detailmk.github.io/2019/10/15/shop-com/index.html">
<meta property="og:site_name" content="coder--编写代码,制造魔法">
<meta property="og:description" content="title:基于ssm的电商系统date: 2019-10-15 09:22:09tags: [“java框架”]categories: ssm 基于ssm的电商系统[TOC] 环境搭建** maven 多模块 聚合  ego-parent(pom) ​    ego-common(jar，公共类、枚举、工具类) ego-manager(pom，管理员管理系统) ​    ego-manager-">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2019/10/18/sKjuCpk7e5vZI6S.jpg">
<meta property="og:image" content="https://i.loli.net/2019/10/23/yV1EBqMHvL6brzj.jpg">
<meta property="og:image" content="https://i.loli.net/2019/10/23/vuhrclHkXY8yCox.jpg">
<meta property="og:updated_time" content="2019-10-24T13:55:39.573Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="coder--编写代码,制造魔法">
<meta name="twitter:description" content="title:基于ssm的电商系统date: 2019-10-15 09:22:09tags: [“java框架”]categories: ssm 基于ssm的电商系统[TOC] 环境搭建** maven 多模块 聚合  ego-parent(pom) ​    ego-common(jar，公共类、枚举、工具类) ego-manager(pom，管理员管理系统) ​    ego-manager-">
<meta name="twitter:image" content="https://i.loli.net/2019/10/18/sKjuCpk7e5vZI6S.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'detailmk'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://detailmk.github.io/2019/10/15/shop-com/">





  <title> | coder--编写代码,制造魔法</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">coder--编写代码,制造魔法</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Talk is cheap. Show me the code.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://detailmk.github.io/2019/10/15/shop-com/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Meng Kai">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/mengkai.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="coder--编写代码,制造魔法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline"></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-15T09:22:09+08:00">
                2019-10-15
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-10-24T21:55:39+08:00">
                2019-10-24
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>title:基于ssm的电商系统<br>date: 2019-10-15 09:22:09<br>tags: [“java框架”]<br>categories: ssm</p>
<h1 id="基于ssm的电商系统"><a href="#基于ssm的电商系统" class="headerlink" title="基于ssm的电商系统"></a>基于ssm的电商系统</h1><p>[TOC]</p>
<p>环境搭建<strong><strong><strong>**</strong></strong></strong></p>
<p>maven 多模块 聚合</p>
<blockquote>
<p>ego-parent(pom)</p>
<p>​    ego-common(jar，公共类、枚举、工具类)</p>
<p>ego-manager(pom，管理员管理系统)</p>
<p>​    ego-manager-pojo(jar，实体类)<br>​    ego-manager-mapper(jar，持久层，xml)<br>​    ego-manager-service(jar，业务层)<br>​    ego-manager-web(war，控制层和视图层)</p>
<p>ego-portal(pom，用户门户系统)</p>
<p>​    ego-portal-pojo(jar，实体类)<br>​    ego-portal-mapper(jar，持久层，xml)<br>​    ego-portal-service(jar，业务层)<br>​    ego-portal-web(war，控制层和视图层)</p>
<p>ego-rpc(pom，服务治理)</p>
<p>​    ego-rpc-pojo(jar，实体类)<br>​    ego-rpc-mapper(jar，持久层，xml)<br>​    ego-rpc-service(jar，业务层接口)<br>​    ego-rpc-serviceImpl(jar，业务层实现)</p>
<p>ego-sso(pon，单点登录)</p>
<p>​    ego-sso-pojo(jar，实体类)<br>​    ego-sso-mapper(jar，持久层，xml)<br>​    ego-sso-service(jar，业务层接口)<br>​    ego-sso-serviceImpl(jar，业务层实现)</p>
<p>ego-order(pom，订单系统)</p>
<p>​    ego-order-pojo(jar，实体类)<br>​    ego-order-mapper(jar，持久层，xml)<br>​    ego-order-service(jar，业务层)<br>​    ego-order-web(war，控制层和视图层)</p>
</blockquote>
<h2 id="商品模块"><a href="#商品模块" class="headerlink" title="商品模块"></a>商品模块</h2><h3 id="产品分类添加"><a href="#产品分类添加" class="headerlink" title="产品分类添加"></a>产品分类添加</h3><p>商品分类添加实现思路:</p>
<p>处理级联查询–&gt;其他参数–&gt;完成添加操作–&gt;图片上传</p>
<p>pojo–&gt;mapper–&gt;service–&gt;controller</p>
<p>处理级联controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/category/&#123;parentId&#125;"</span>,method=RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;GoodsCategory&gt; <span class="title">categoryListByParentId</span><span class="params">(@PathVariable Short parentId)</span></span>&#123;</span><br><span class="line">    <span class="comment">//查询商品分类</span></span><br><span class="line">    <span class="keyword">return</span>  goodsCategoryListService.selectCategoryList(parentId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4></li>
</ul>
<p>nginx来存储上传的图片</p>
<p><strong>技能</strong>:学会上网查询修改成自己需要的工具类</p>
<p>——– 文件上传工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FTPUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(FTPUtil.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> host     服务器IP</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> port     服务器端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 服务器用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 服务器密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path     /home/ftpuser/ego/年/月/日</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名1.jpg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> is       文件流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">fileUpload</span><span class="params">(String host, <span class="keyword">int</span> port, String username, String password,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    String path, String fileName, InputStream is)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断操作是否正确</span></span><br><span class="line">        <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 返回的文件名</span></span><br><span class="line">        String remote = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 创建ftp客户端</span></span><br><span class="line">        FTPClient ftpClient = <span class="keyword">new</span> FTPClient();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置编码字符集</span></span><br><span class="line">            ftpClient.setControlEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">            <span class="comment">// 连接FTP服务器</span></span><br><span class="line">            ftpClient.connect(host, port);</span><br><span class="line">            <span class="comment">// 登录</span></span><br><span class="line">            flag = ftpClient.login(username, password);</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                logger.error(<span class="string">"文件服务器用户名或密码错误"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取登录的状态码</span></span><br><span class="line">            <span class="keyword">int</span> reply = ftpClient.getReplyCode();</span><br><span class="line">            <span class="keyword">if</span> (!FTPReply.isPositiveCompletion(reply)) &#123;</span><br><span class="line">                ftpClient.disconnect();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*****************创建目录 一次只能创建一个目录*****************/</span></span><br><span class="line">            String basePath = <span class="string">"/"</span>;</span><br><span class="line">            <span class="keyword">for</span> (String p : path.split(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                basePath += (p + <span class="string">"/"</span>);</span><br><span class="line">                <span class="comment">// 判断目录是否已经存在</span></span><br><span class="line">                <span class="keyword">boolean</span> hasPath = ftpClient.changeWorkingDirectory(basePath);</span><br><span class="line">                <span class="keyword">if</span> (!hasPath) &#123;</span><br><span class="line">                    <span class="comment">// 创建目录 一次只能创建一个目录，失败的原因都是权限问题</span></span><br><span class="line">                    ftpClient.makeDirectory(basePath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重新指定上传的路径</span></span><br><span class="line">            ftpClient.changeWorkingDirectory(path);</span><br><span class="line">            <span class="comment">/*******************************************************/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 指定上传方式为二进制方式</span></span><br><span class="line">            ftpClient.setFileType(FTP.BINARY_FILE_TYPE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 得到文件后缀</span></span><br><span class="line">            String suffix = fileName.substring(fileName.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">            System.out.println(<span class="string">"文件后缀为："</span> + suffix);</span><br><span class="line"></span><br><span class="line">            remote = UUIDUtil.getUUID() + suffix;</span><br><span class="line">            <span class="comment">// remote指定上传远程服务器的文件名 local指本地的输入流</span></span><br><span class="line">            flag = ftpClient.storeFile(remote, is);</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                logger.error(<span class="string">"文件上传失败，可能是权限，防火墙等问题"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"文件上传错误，错误原因："</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(is != <span class="keyword">null</span>)</span><br><span class="line">                    is.close();</span><br><span class="line"></span><br><span class="line">                ftpClient.logout();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(ftpClient.isConnected())</span><br><span class="line">                    ftpClient.disconnect();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.error(<span class="string">"文件上传错误，错误原因："</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"D://kobe.jpg"</span>));</span><br><span class="line">        fileUpload(<span class="string">"192.168.174.130"</span>, <span class="number">21</span>, <span class="string">"ftpuser"</span>, <span class="string">"shsxtego"</span>,</span><br><span class="line">                <span class="string">"/home/ftpuser/ego/2019/10/15"</span>, <span class="string">"kobe.jpg"</span>, is);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据前台需要的json数据来完成后台代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> is</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FileResult <span class="title">fileUpload</span><span class="params">(String fileName, InputStream is)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 修改文件上传路径，修改为：/home/ftpuser/ego/年/月/日</span></span><br><span class="line">        String dateStr = DateUtil.getDateStr(LocalDateTime.now(), DateUtil.pattern_date);</span><br><span class="line">        <span class="comment">// 最终文件上传路径</span></span><br><span class="line">        String basePath = ftpPath + dateStr;</span><br><span class="line">        <span class="comment">// 文件上传，返回上传成功的文件名</span></span><br><span class="line">        String result = FTPUtil.fileUpload(ftpHost, ftpPort, ftpUsername, ftpPassword, basePath, fileName, is);</span><br><span class="line">        <span class="comment">// 判断</span></span><br><span class="line">        FileResult fileResult = <span class="keyword">new</span> FileResult();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == result || result.length() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            fileResult.setMessage(<span class="string">"文件上传失败"</span>);</span><br><span class="line">            fileResult.setError(<span class="string">"error"</span>);</span><br><span class="line">            <span class="keyword">return</span> fileResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fileResult.setMessage(<span class="string">"文件上传成功"</span>);</span><br><span class="line">        fileResult.setSuccess(<span class="string">"success"</span>);</span><br><span class="line">        <span class="comment">// 修改返回的文件地址，修改为：http://192.168.10.100/2019/09/10/939317e3c2084d239a4f21b1684b8df4.jpg</span></span><br><span class="line">        String fileUrl = <span class="string">"http://"</span> + ftpHost + <span class="string">"/"</span> + dateStr + <span class="string">"/"</span> + result;</span><br><span class="line">        fileResult.setFileUrl(fileUrl);</span><br><span class="line">        <span class="keyword">return</span> fileResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="产品分类查询"><a href="#产品分类查询" class="headerlink" title="产品分类查询"></a>产品分类查询</h3><p>service层实现思路:<br>先查询一级标题创建结果集合存储</p>
<p>将查询集合复制到结果集合,清空查询条件,后面查询二级,三级同样方法</p>
<p>二级设置子集合三级,一级设置子集合二级,返回集合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有商品分类</span></span><br><span class="line"><span class="comment"> *用集合存储,体现父子类关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;GoodsCategoryVo&gt; <span class="title">selectAllCategoryList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建查询对象</span></span><br><span class="line">    GoodsCategoryExample example=<span class="keyword">new</span> GoodsCategoryExample();</span><br><span class="line">    <span class="comment">//设置所有一级分类(parentId=0;level=1)</span></span><br><span class="line">    example.createCriteria().andParentIdEqualTo((<span class="keyword">short</span>) <span class="number">0</span>).andLevelEqualTo((<span class="keyword">byte</span>) <span class="number">1</span>);</span><br><span class="line">   <span class="comment">//查询一级分类</span></span><br><span class="line">    List&lt;GoodsCategory&gt; gcList1=goodsCategoryMapper.selectByExample(example);</span><br><span class="line">    <span class="comment">//创建返回结果集合存储一级分类</span></span><br><span class="line">    List&lt;GoodsCategoryVo&gt; gcvList1=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (GoodsCategory gc1:gcList1)&#123;</span><br><span class="line">        <span class="comment">//创建vo对象</span></span><br><span class="line">        GoodsCategoryVo gcv1=<span class="keyword">new</span> GoodsCategoryVo();</span><br><span class="line">        <span class="comment">//复制属性</span></span><br><span class="line">        BeanUtils.copyProperties(gc1,gcv1);</span><br><span class="line">        <span class="comment">//查询二级分类</span></span><br><span class="line">        <span class="comment">//清空查询条件</span></span><br><span class="line">        example.clear();</span><br><span class="line">        <span class="comment">//重新设置查询条件(二级分类)</span></span><br><span class="line">        example.createCriteria().andParentIdEqualTo(gc1.getId()).andLevelEqualTo((<span class="keyword">byte</span>) <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//查询二级分类</span></span><br><span class="line">        List&lt;GoodsCategory&gt; gcList2=goodsCategoryMapper.selectByExample(example);</span><br><span class="line">        <span class="comment">//创建返回结果集合存储二级分类</span></span><br><span class="line">        List&lt;GoodsCategoryVo&gt; gcvList2=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (GoodsCategory gc2:gcList2) &#123;</span><br><span class="line">            <span class="comment">//创建vo对象</span></span><br><span class="line">            GoodsCategoryVo gcv2 = <span class="keyword">new</span> GoodsCategoryVo();</span><br><span class="line">            <span class="comment">//复制属性</span></span><br><span class="line">            BeanUtils.copyProperties(gc2, gcv2);</span><br><span class="line">            <span class="comment">//查询三级分类</span></span><br><span class="line">            <span class="comment">//清空查询条件</span></span><br><span class="line">            example.clear();</span><br><span class="line">            <span class="comment">//重新设置查询条件(三级分类)</span></span><br><span class="line">            example.createCriteria().andParentIdEqualTo(gc2.getId()).andLevelEqualTo((<span class="keyword">byte</span>) <span class="number">3</span>);</span><br><span class="line">            <span class="comment">//查询三级分类</span></span><br><span class="line">            List&lt;GoodsCategory&gt; gcList3 = goodsCategoryMapper.selectByExample(example);</span><br><span class="line">            <span class="comment">//创建返回结果集合存储三级分类</span></span><br><span class="line">            List&lt;GoodsCategoryVo&gt; gcvList3 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (GoodsCategory gc3 : gcList3) &#123;</span><br><span class="line">                <span class="comment">//创建vo对象</span></span><br><span class="line">                GoodsCategoryVo gcv3 = <span class="keyword">new</span> GoodsCategoryVo();</span><br><span class="line">                <span class="comment">//复制属性</span></span><br><span class="line">                BeanUtils.copyProperties(gc3, gcv3);</span><br><span class="line">                gcvList3.add(gcv3);</span><br><span class="line">            &#125;</span><br><span class="line">            gcv2.setChildren(gcvList3);</span><br><span class="line">            gcvList2.add(gcv2);</span><br><span class="line">        &#125;</span><br><span class="line">        gcv1.setChildren(gcvList2);</span><br><span class="line">        gcvList1.add(gcv1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> gcvList1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="产品添加"><a href="#产品添加" class="headerlink" title="产品添加"></a>产品添加</h3><ul>
<li>级联查询<ul>
<li>js级联查询工具(支持3级)</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 根据父ID查询子分类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCategory</span>(<span class="params">parentId, nextNode, level, hiddenId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 用户重新选择顶级分类时，重置下级分类为：请选择商品分类，且清空下级分类信息</span></span><br><span class="line">    <span class="keyword">var</span> htmlStr = <span class="string">"&lt;option value='0'&gt;请选择商品分类&lt;/option&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == parentId) &#123;</span><br><span class="line">        $(<span class="string">"#"</span> + nextNode).html(htmlStr);</span><br><span class="line">        <span class="comment">// 分割字符串处理第三级分类</span></span><br><span class="line">        <span class="keyword">var</span> nextIds = nextNode.split(<span class="string">'_'</span>);</span><br><span class="line">        <span class="keyword">var</span> nextIdNum = <span class="built_in">parseInt</span>(nextIds[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">2</span> == nextIdNum) &#123;</span><br><span class="line">            nextIdNum++;</span><br><span class="line">            $(<span class="string">"#"</span> + nextIds[<span class="number">0</span>] + <span class="string">"_"</span> + nextIds[<span class="number">1</span>] + <span class="string">"_"</span> + nextIdNum).html(htmlStr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置分类隐藏域的值为0</span></span><br><span class="line">        $(<span class="string">"#"</span> + hiddenId).val(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> url = getProjectName() + <span class="string">"/product/category/"</span> + parentId;</span><br><span class="line">    <span class="comment">// ajax从后台加载子分类</span></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: url,</span><br><span class="line">        type: <span class="string">"GET"</span>,</span><br><span class="line">        data: &#123;<span class="string">"parentId"</span>: parentId&#125;,</span><br><span class="line">        dataType: <span class="string">"JSON"</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (result.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; result.length; i++) &#123;</span><br><span class="line">                    htmlStr += <span class="string">"&lt;option value='"</span> + result[i].id + <span class="string">"'&gt;"</span> + result[i].name + <span class="string">"&lt;/option&gt;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                $(<span class="string">"#"</span> + nextNode).html(htmlStr);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                layer.alert(<span class="string">"获取子分类失败！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// jQuery的alert插件</span></span><br><span class="line">            layer.alert(<span class="string">"获取子分类失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取项目路径</span></span><br><span class="line"><span class="comment"> * @returns &#123;string&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProjectName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前网址 比如：http://localhost:8080/ego-manager-web/product/category/edit/1</span></span><br><span class="line">    <span class="keyword">var</span> curWwwPath = <span class="built_in">window</span>.document.location.href;</span><br><span class="line">    <span class="comment">// 获取主机地址之后的目录 比如：/ego-manager-web/product/category/edit/1</span></span><br><span class="line">    <span class="keyword">var</span> pathName = <span class="built_in">window</span>.document.location.pathname;</span><br><span class="line">    <span class="keyword">var</span> pos = curWwwPath.indexOf(pathName);</span><br><span class="line">    <span class="comment">// 获取主机地址 比如：http://localhost:8080</span></span><br><span class="line">    <span class="keyword">var</span> localhostPaht = curWwwPath.substring(<span class="number">0</span>, pos);</span><br><span class="line">    <span class="comment">// 获取带"/"的项目名 比如：/ego-manager-web</span></span><br><span class="line">    <span class="keyword">var</span> projectName = pathName.substring(<span class="number">0</span>, pathName.substr(<span class="number">1</span>).indexOf(<span class="string">'/'</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> projectName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取多级联动的商品分类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_category</span>(<span class="params">id, next, select_id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">'/index?m=Home&amp;c=api&amp;a=get_category&amp;parent_id='</span> + id;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type: <span class="string">"GET"</span>,</span><br><span class="line">        url: url,</span><br><span class="line">        error: <span class="function"><span class="keyword">function</span> (<span class="params">request</span>) </span>&#123;</span><br><span class="line">            alert(<span class="string">"服务器繁忙, 请联系管理员!4"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">v</span>) </span>&#123;</span><br><span class="line">            v = <span class="string">"&lt;option value='0'&gt;请选择商品分类&lt;/option&gt;"</span> + v;</span><br><span class="line">            $(<span class="string">'#'</span> + next).empty().html(v);</span><br><span class="line">            (select_id &gt; <span class="number">0</span>) &amp;&amp; $(<span class="string">'#'</span> + next).val(select_id);<span class="comment">//默认选中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>图片上传</li>
</ul>
<p>专门global.js处理重复js代码</p>
<p>表单提交(myFormValidate.js处理重复的保存按钮功能)</p>
<ul>
<li><p>商品相册上传(依次排队上传)</p>
<p>思路:如果图片上传成功,则将其设置到商品图片对象中存储</p>
<ul>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 商品相册保存</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> goodsId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/goodsImages/save"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BaseResult <span class="title">goodsImagesSave</span><span class="params">(MultipartFile file, Integer goodsId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileResult fileResult = fileUploads.fileUpload(file.getOriginalFilename(), file.getInputStream());</span><br><span class="line">        <span class="comment">// 判断图片是否上传成功</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != fileResult.getFileUrl() &amp;&amp; fileResult.getFileUrl().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            GoodsImages goodsImages = <span class="keyword">new</span> GoodsImages();</span><br><span class="line">            goodsImages.setImageUrl(fileResult.getFileUrl());</span><br><span class="line">            goodsImages.setGoodsId(goodsId);</span><br><span class="line">            <span class="keyword">return</span> goodsImagesService.saveGoodsImages(goodsImages);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.error(<span class="string">"文件上传失败，失败原因："</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BaseResult.error();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="商品分页查询"><a href="#商品分页查询" class="headerlink" title="商品分页查询"></a>商品分页查询</h3><p>用前端模板 doT.js 修改</p>
<p>思路:创建分页对象-&gt;创建查询对象-&gt;分页对象设置查询参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询商品列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> goods</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageNum</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BaseResult <span class="title">selectGoodsListByPage</span><span class="params">(Goods goods, Integer pageNum, Integer pageSize)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//构建分页对象</span></span><br><span class="line">    PageHelper.startPage(pageNum,pageSize);</span><br><span class="line">    <span class="comment">//创建查询对象</span></span><br><span class="line">    GoodsExample example=<span class="keyword">new</span> GoodsExample();</span><br><span class="line">    GoodsExample.Criteria criteria = example.createCriteria();</span><br><span class="line">    <span class="comment">//设置查询参数</span></span><br><span class="line">    <span class="comment">//商品分类参数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span>!=goods.getCatId()&amp;&amp;<span class="number">0</span>!=goods.getCatId())&#123;</span><br><span class="line">        criteria.andCatIdEqualTo(goods.getCatId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//商品品牌参数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span>!=goods.getBrandId()&amp;&amp;<span class="number">0</span>!=goods.getBrandId())&#123;</span><br><span class="line">        criteria.andBrandIdEqualTo(goods.getBrandId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//模糊查询商品名称</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span>!=goods.getGoodsName()&amp;&amp;goods.getGoodsName().trim().length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        criteria.andGoodsNameLike(<span class="string">"%"</span>+goods.getGoodsName()+<span class="string">"%"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询商品设置到分页对象中</span></span><br><span class="line">    List&lt;Goods&gt; goodsList=goodsMapper.selectByExample(example);</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(goodsList)&amp;&amp;goodsList.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        PageInfo&lt;Goods&gt; goodsPageInfo=<span class="keyword">new</span> PageInfo&lt;&gt;(goodsList);</span><br><span class="line">        <span class="keyword">return</span> BaseResult.success(goodsPageInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> BaseResult.error();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><p>–&gt;利用缓存处理大量商品查询速度过慢问题</p>
<p>redis-cli </p>
<h5 id="操作-redis-五种数据类型"><a href="#操作-redis-五种数据类型" class="headerlink" title="操作 redis 五种数据类型"></a>操作 redis 五种数据类型</h5><h6 id="操作-String"><a href="#操作-String" class="headerlink" title="操作 String **"></a>操作 String **</h6><p>Set:添加一条 String 类型数据<br>Get:获取一条 String 类型数据<br>Mset:添加多条 String 类型数据<br>Mget:获取多条 String 类型数据 </p>
<h6 id="操作-hash"><a href="#操作-hash" class="headerlink" title="操作 hash **"></a>操作 hash **</h6><p>Hset:添加一条 hash 类型数据<br>Hget:获取一条 hash 类型数据<br>Hmset:添加多条 hash 类型数据<br>Hmget:获取多条 hash 类型数据<br>HgetAll:获取指定所有 hash 类型数据<br>hdel:删除指定 hash 类型数据(一条或多条) </p>
<h6 id="操作-list"><a href="#操作-list" class="headerlink" title="操作 list"></a>操作 list</h6><p>Lpush:左添加(头)list 类型数据<br>Rpush:右添加(尾)类型数据<br>Lrange: 获取 list 类型数据 start 起始下标 end 结束下标 包含关系<br>llen:获取条数<br>lrem:删除列表中几个指定 list 类型数据 </p>
<h6 id="操作-set"><a href="#操作-set" class="headerlink" title="操作 set"></a>操作 set</h6><p>Sadd:添加 set 类型数据<br>Smembers:获取 set 类型数据<br>scard:获取条数<br>srem:删除数据 </p>
<h6 id="操作-sorted-set"><a href="#操作-sorted-set" class="headerlink" title="操作 sorted set"></a>操作 sorted set</h6><p>sorted set 是通过分数值来进行排序的，分数值越大，越靠后。<br>Zadd:添加 sorted set 类型数据<br>Zrange:获取 sorted set 类型数据<br>zcard:获取条数<br>zrem:删除数据<br>Zadd 需要将 Float 或者 Double 类型分数值参数，放置在值参数之前</p>
<h5 id="Redis-中以层级关系、目录形式存储数据"><a href="#Redis-中以层级关系、目录形式存储数据" class="headerlink" title="Redis 中以层级关系、目录形式存储数据 **"></a>Redis 中以层级关系、目录形式存储数据 **</h5><p>–&gt;防止数据覆盖以及数据过多冗余难以区分</p>
<p>NOAUTH Authentication required.错误解决:auth [password]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[2]&gt; <span class="built_in">set</span> user:userorder3:order03 mk3-order</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[2]&gt; <span class="built_in">set</span> user:userorder2:order02 mk2-order</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h5 id="设置-key-的失效时间"><a href="#设置-key-的失效时间" class="headerlink" title="设置 key 的失效时间"></a>设置 key 的失效时间</h5><p>Redis 有四个不同的命令可以用于设置键的生存时间(键可以存在多久)或过期时间(键什么 时候会被删除) : </p>
<p>EXPlRE <key> <ttl> 命令用于将键 key 的生存时间设置为 ttl 秒。<br>PEXPIRE <key> <ttl> 命令用于将键 key 的生存时间设置为 ttl 毫秒。<br>EXPIREAT <key> &lt; timestamp&gt; 命令用于将键 key 的过期时间设置为 timestamp 所指 定的秒数时间戳。<br>PEXPIREAT <key> &lt; timestamp &gt; 命令用于将键 key 的过期时间设置为 timestamp 所 指定的毫秒数时间戳。  TTL:获取的值为-1 说明此 key 没有设置有效期，当值为-2 时证明过了有效期。 </key></key></ttl></key></ttl></key></p>
<p>方法一:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[2]&gt; <span class="built_in">set</span> code <span class="built_in">test</span> EX 180</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[2]&gt; ttl code</span><br><span class="line">(<span class="built_in">integer</span>) 175</span><br><span class="line">127.0.0.1:6379[2]&gt; ttl code</span><br><span class="line">(<span class="built_in">integer</span>) 170</span><br></pre></td></tr></table></figure>

<p>方法二:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[2]&gt; expire code 200</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[2]&gt; ttl code</span><br><span class="line">(<span class="built_in">integer</span>) 198</span><br><span class="line">127.0.0.1:6379[2]&gt; ttl code</span><br><span class="line">(<span class="built_in">integer</span>) 196</span><br></pre></td></tr></table></figure>

<p>方法三： </p>
<p>第一个参数：key     第二个参数：value </p>
<p>第三个参数：NX 是不存在时才 set，XX 是存在时才 set     第四个参数：EX 是秒，PX 是毫秒 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[2]&gt; <span class="built_in">set</span> cod test1 nx ex 200</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[2]&gt; ttl cod</span><br><span class="line">(<span class="built_in">integer</span>) 195</span><br><span class="line">127.0.0.1:6379[2]&gt; ttl cod</span><br><span class="line">(<span class="built_in">integer</span>) 193</span><br></pre></td></tr></table></figure>

<h6 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h6><p>Del:用于删除数据（通用，适用于所有数据类型） Hdel:用于删除 hash 类型数据 </p>
<h5 id="jedis"><a href="#jedis" class="headerlink" title="jedis"></a>jedis</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 操作 String </span></span><br><span class="line"><span class="meta">@Test</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testString</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">	<span class="comment">// 添加一条数据    </span></span><br><span class="line">	jedis.set(<span class="string">"username"</span>, <span class="string">"zhangsan"</span>);    </span><br><span class="line">	jedis.set(<span class="string">"age"</span>, <span class="string">"18"</span>);        </span><br><span class="line">	<span class="comment">// 添加多条数据 参数奇数为 key 参数偶数为 value    </span></span><br><span class="line">	jedis.mset(<span class="string">"address"</span>, <span class="string">"bj"</span>, <span class="string">"sex"</span>, <span class="string">"1"</span>);        </span><br><span class="line">	<span class="comment">// 获取一条数据    </span></span><br><span class="line">	String username = jedis.get(<span class="string">"username"</span>);    </span><br><span class="line">	System.out.println(username);        </span><br><span class="line">	<span class="comment">// 获取多条数据   </span></span><br><span class="line">	List&lt;String&gt; list = jedis.mget(<span class="string">"username"</span>, <span class="string">"age"</span>, <span class="string">"address"</span>, <span class="string">"sex"</span>);    </span><br><span class="line">	<span class="keyword">for</span> (String str : list) &#123;       </span><br><span class="line">		System.out.println(str);    </span><br><span class="line">	&#125;        </span><br><span class="line">	<span class="comment">// 删除    </span></span><br><span class="line">	<span class="comment">//jedis.del("username"); </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 操作 Hash </span></span><br><span class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHash</span><span class="params">()</span> </span>&#123;    </span><br><span class="line"><span class="comment">/*     * 添加一条数据</span></span><br><span class="line"><span class="comment">     *     参数一： redis 的 key     </span></span><br><span class="line"><span class="comment">     *     参数二： hash 的 key     </span></span><br><span class="line"><span class="comment">     *     参数三： hash 的 value     </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">     jedis.hset(<span class="string">"userInfo"</span>, <span class="string">"name"</span>, <span class="string">"lisi"</span>);        </span><br><span class="line">     <span class="comment">// 添加多条数据    </span></span><br><span class="line">     Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();    </span><br><span class="line">     map.put(<span class="string">"age"</span>, <span class="string">"20"</span>);    </span><br><span class="line">     map.put(<span class="string">"sex"</span>, <span class="string">"1"</span>);    </span><br><span class="line">     jedis.hmset(<span class="string">"userInfo"</span>, map);        </span><br><span class="line">     <span class="comment">// 获取一条数据    </span></span><br><span class="line">     String name = jedis.hget(<span class="string">"userInfo"</span>, <span class="string">"name"</span>);    </span><br><span class="line">     System.out.println(name);        </span><br><span class="line">     <span class="comment">// 获取多条数据    </span></span><br><span class="line">     List&lt;String&gt; list = jedis.hmget(<span class="string">"userInfo"</span>, <span class="string">"age"</span>, <span class="string">"sex"</span>);    </span><br><span class="line">     <span class="keyword">for</span> (String str : list) &#123;       </span><br><span class="line">    	 System.out.println(str);    </span><br><span class="line">     &#125;        </span><br><span class="line">     <span class="comment">// 获取 Hash 类型所有的数据    </span></span><br><span class="line">     Map&lt;String, String&gt; userMap = jedis.hgetAll(<span class="string">"userInfo"</span>);    </span><br><span class="line">     <span class="keyword">for</span> (Entry&lt;String, String&gt; userInfo : userMap.entrySet()) &#123;       								System.out.println(userInfo.getKey() + <span class="string">"--"</span> + userInfo.getValue());    </span><br><span class="line">     &#125;        </span><br><span class="line">     <span class="comment">// 删除 用于删除 hash 类型数据   </span></span><br><span class="line">     <span class="comment">//jedis.hdel("userInfo", "name"); </span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>将 java对象转换为 byte数组 序列化过程 </p>
<p>将 byte数组转换为 java对象  反序列化 </p>
<h6 id="jedis-API"><a href="#jedis-API" class="headerlink" title="jedis API"></a>jedis API</h6><p><a href="https://blog.csdn.net/lovezhaohaimig/article/details/81669311" target="_blank" rel="noopener">jedis API</a></p>
<h5 id="Redis-持久化"><a href="#Redis-持久化" class="headerlink" title="Redis 持久化"></a>Redis 持久化</h5><p>对于 Redis,其提供了不同级别的持久化操作: </p>
<ol>
<li><p>RDB 持久化可以在指定的时间间隔内生成数据集的时间点快照 </p>
</li>
<li><p>AOF 持久化记录服务器执行的所有写操作命令，并在服务器启动时，通过重新执行这些命令来还原数据集。AOF 文件中的命令全部以 Redis 协议的格式来保存，新命令会被追 加到文件的末尾。 Redis 还可以在后台对 AOF 文件进行重写（rewrite），使得 AOF 文件 的体积不会超出保存数据集状态所需的实际大小。 </p>
</li>
<li><p>Redis 还可以同时使用 AOF 持久化和 RDB 持久化。在这种情况下，当 Redis 重 启时,它会优先使用 AOF 文件来还原数据集,因为 AOF 文件保存的数据集通常比 RDB 文件 所保存的数据集更完整。</p>
</li>
<li><p>持久化功能当然也可以进行关闭操作，让数据仅在服务器运行时存在. </p>
</li>
</ol>
<p>快照运行方式<br>   当 Redis 需要保存 dump.rdb 文件时， 服务器执行以下操作： </p>
<ol>
<li>Redis 调用 fork() ，同时拥有父进程和子进程。 </li>
<li>子进程将数据集写入到一个临时 RDB 文件中。 </li>
<li>当子进程完成对新 RDB 文件的写入时，Redis 用新 RDB 文件替换原来的 RDB 文件，并删除旧<br>的 RDB 文件。 </li>
</ol>
<p>RDB 优缺点<br>   优点:  </p>
<ol>
<li>RDB 是一个非常紧凑（compact）的文件，它保存了 Redis 在某个时间点上的数据集。该文件适<br>合用于进行备份 。比如说，可以在最近的 24 小时内，每小时备份一次 RDB 文件，并且在每<br>个月的每一天，也备份一个 RDB 文件。 这样的话，即使遇上问题，也可以随时将数据集还原到<br>不同的版本。 </li>
<li>RDB 非常适用于灾难恢复（disaster recovery）：它只有一个文件，并且内容都非常紧凑，可<br>以（在加密后）将它传送到别的数据中心 </li>
<li>RDB 可以最大化 Redis 的性能：父进程在保存 RDB 文件时唯一要做的就是 fork 出一个子进<br>程，然后这个子进程就会处理接下来的所有保存工作，父进程无须执行任何磁盘 I/O 操作。 </li>
<li>RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快。<br>缺点 </li>
<li>如果想要做到数据实时备份级别，此时使用 rdb 快照进行备份可能会出现数据无法备份完整情<br>况，比如在数据备份完毕下次备份操作发起前，服务器由于某种原因意外宕机，此时采用 rdb 就<br>无法对当前情况做的实时响应处理 2. RDB 需要经常 fork 子进程来保存数据集到硬盘上,当数据集比较大的时候,fork 的过程是非常耗 时的,可能会导致 Redis 在一些毫秒级内不能响应客户端的请求.如果数据集巨大并且 CPU 性能不<br>是很好的情况下,这种情况会持续 1 秒,AOF 也需要 fork,但是你可以调节重写日志文件的频率来提<br>高数据集的耐久度.</li>
</ol>
<p>AOF 只追加操作的文件 </p>
<ul>
<li><p>RDB 需要经常 fork 子进程来保存数据集到硬盘上,当数据集比较大的时候,fork 的过程是非 常耗时的,可能会导致 Redis 在一些毫秒级内不能响应客户端的请求.如果数据集巨大并且 CPU 性能不是很好的情况下,这种情况会持续 1 秒,AOF 也需要 fork,但是你可以调节重写日志 文件的频率来提高数据集的耐久度. </p>
<p>appendonly yes<br>从现在开始， 每当 Redis 执行一个改变数据集的命令时（比如 SET）， 这个命令就会被 追加到 AOF 文件的末尾。这样的话， 当 Redis 重新启时， 程序就可以通过重新执行 AOF 文件中的命令来达到重建数据集的目的。 </p>
</li>
</ul>
<p>RDB与AOF区别(搜整理)—面试<strong>*****</strong></p>
<p>RDB的save通过时间间歇处理 AOF通过将命令追加到AOF文件中</p>
<p>如果可以容忍数据部分丢失,不要求数据一致性的话用RDB</p>
<h5 id="Redis-搭建主从复用-读写分离"><a href="#Redis-搭建主从复用-读写分离" class="headerlink" title="Redis 搭建主从复用-读写分离"></a>Redis 搭建主从复用-读写分离</h5><p>Redis 支持主从复用。数据可以从主服务器向任意数量的从服务器上同步，同步使用的 是发布/订阅机制。</p>
<p>–&gt;为解决单节点下服务器读取数据的压力过大的问题</p>
<h5 id="Spring-Data-Redis-操作-Redis"><a href="#Spring-Data-Redis-操作-Redis" class="headerlink" title="Spring Data Redis 操作 Redis"></a>Spring Data Redis 操作 Redis</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 操作 String </span></span><br><span class="line"><span class="meta">@Test</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testString</span><span class="params">()</span> </span>&#123;     </span><br><span class="line">	ValueOperations&lt;String, Object&gt; valueOperations = redisTemplate.opsForValue(); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 添加一条数据     </span></span><br><span class="line">    valueOperations.set(<span class="string">"username"</span>, <span class="string">"zhangsan"</span>);     </span><br><span class="line">    valueOperations.set(<span class="string">"age"</span>, <span class="string">"18"</span>); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// redis中以层级关系、目录形式存储数据</span></span><br><span class="line"> valueOperations.set(<span class="string">"user:01"</span>, <span class="string">"lisi"</span>); </span><br><span class="line"> valueOperations.set(<span class="string">"user:02"</span>, <span class="string">"wangwu"</span>); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 添加多条数据</span></span><br><span class="line">     Map&lt;String, String&gt; userMap = <span class="keyword">new</span> HashMap&lt;&gt;();    </span><br><span class="line">     userMap.put(<span class="string">"address"</span>, <span class="string">"bj"</span>);     </span><br><span class="line">     userMap.put(<span class="string">"sex"</span>, <span class="string">"1"</span>);     </span><br><span class="line">     valueOperations.multiSet(userMap); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取一条数据</span></span><br><span class="line">     Object username = valueOperations.get(<span class="string">"username"</span>);     </span><br><span class="line">     System.out.println(username); </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取多条数据</span></span><br><span class="line">     List&lt;String&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;();     </span><br><span class="line">     keys.add(<span class="string">"username"</span>);     </span><br><span class="line">     keys.add(<span class="string">"age"</span>);     </span><br><span class="line">     keys.add(<span class="string">"address"</span>);     </span><br><span class="line">     keys.add(<span class="string">"sex"</span>);     </span><br><span class="line">     List&lt;Object&gt; resultList = valueOperations.multiGet(keys);     </span><br><span class="line">     <span class="keyword">for</span> (Object str : resultList) &#123;         </span><br><span class="line">     	System.out.println(str); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 删除</span></span><br><span class="line">     redisTemplate.delete(<span class="string">"username"</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 操作 Hash </span></span><br><span class="line"><span class="meta">@Test</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHash</span><span class="params">()</span> </span>&#123;     </span><br><span class="line">	HashOperations&lt;String, String, String&gt; hashOperations = redisTemplate.opsForHash(); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*      * 添加一条数据</span></span><br><span class="line"><span class="comment">      *     参数一： redis的 key </span></span><br><span class="line"><span class="comment">     *     参数二： hash的 key </span></span><br><span class="line"><span class="comment">     *     参数三： hash的 value </span></span><br><span class="line"><span class="comment">     */</span>     </span><br><span class="line">     hashOperations.put(<span class="string">"userInfo"</span>,<span class="string">"name"</span>,<span class="string">"lisi"</span>); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 添加多条数据     </span></span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap();     </span><br><span class="line">    map.put(<span class="string">"age"</span>, <span class="string">"20"</span>);     </span><br><span class="line">    map.put(<span class="string">"sex"</span>, <span class="string">"1"</span>);     </span><br><span class="line">    hashOperations.putAll(<span class="string">"userInfo"</span>, map); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取一条数据     </span></span><br><span class="line">    String name = hashOperations.get(<span class="string">"userInfo"</span>, <span class="string">"name"</span>);     </span><br><span class="line">    System.out.println(name); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取多条数据     </span></span><br><span class="line">    List&lt;String&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;();     </span><br><span class="line">    keys.add(<span class="string">"age"</span>);     </span><br><span class="line">    keys.add(<span class="string">"sex"</span>);     </span><br><span class="line">    List&lt;String&gt; resultlist =hashOperations.multiGet(<span class="string">"userInfo"</span>, keys);     </span><br><span class="line">    <span class="keyword">for</span> (String str : resultlist) &#123;         </span><br><span class="line">    	System.out.println(str);     </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取 Hash</span></span><br><span class="line">类型所有的数据 </span><br><span class="line">    Map&lt;String, String&gt; userMap = hashOperations.entries(<span class="string">"userInfo"</span>); </span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, String&gt; userInfo : userMap.entrySet()) &#123;         			System.out.println(userInfo.getKey() + <span class="string">"--"</span> + userInfo.getValue());     </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 删除 用于删除 hash类型数据 </span></span><br><span class="line">    hashOperations.delete(<span class="string">"userInfo"</span>, <span class="string">"name"</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>redis缓存数据</p>
<ul>
<li><p>思路:</p>
<p>先查询redis若没有数据从数据库查询,查到数据存储在redis</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先从 Redis查询 </span></span><br><span class="line">    Object jsonUser = redisTemplate.opsForValue().get(<span class="string">"user:id_"</span> + userId);     </span><br><span class="line">    User user = <span class="keyword">null</span>;     </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> != user)&#123;         </span><br><span class="line">    	user = JsonUtil.jsonStr2Object((String) jsonUser, User.class);         </span><br><span class="line">    	<span class="keyword">return</span> user;     </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Redis没有再从 mysql查询 </span></span><br><span class="line">    user = userDao.queryUserById(userId);    </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> != user)&#123;         </span><br><span class="line">    	redisTemplate.opsForValue().set(<span class="string">"user:id_"</span> + userId,JsonUtil.object2JsonStr(user));         </span><br><span class="line">    	<span class="keyword">return</span> user;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="使用redis实现缓存-商品分类以及商品列表"><a href="#使用redis实现缓存-商品分类以及商品列表" class="headerlink" title="使用redis实现缓存(商品分类以及商品列表)"></a>使用redis实现缓存(商品分类以及商品列表)</h4><p>处理思路:</p>
<p>先去redis查询,如果没有去mysql查询,数据放入缓存</p>
<p>如果存在数据,则将数据展示</p>
<p>?存在类似双十一大量数据并发场景,正常通过双缓存解决</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询redis是否有缓存数据</span></span><br><span class="line">ValueOperations&lt;String, String&gt; valueOperations = redisTemplate.opsForValue();</span><br><span class="line">String goodsCategorystr = valueOperations.get(goodsCategoryListKey);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">null</span>!=goodsCategorystr&amp;&amp;goodsCategorystr.length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> JsonUtil.jsonToList(goodsCategorystr,GoodsCategoryVo.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>商品列表查询涉及到条件查询,通过层级关系构建key,在java代码通过数组后遍历数组值来字符串拼接</p>
<p>注意:最后将数据库查询的数据要放在pageinfo对象集合中(否则分页失效(由于查询的数据没有商品总数值))</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化 redis的 key</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        分析：</span></span><br><span class="line"><span class="comment">        此功能查询分为七种 ( 所有条件都包含分页参数 ) ：</span></span><br><span class="line"><span class="comment">            a. 无条件查询</span></span><br><span class="line"><span class="comment">            b. 根据分类查询</span></span><br><span class="line"><span class="comment">            c. 根据品牌查询</span></span><br><span class="line"><span class="comment">            d. 根据关键词查询</span></span><br><span class="line"><span class="comment">            e. 根据分类 _ 品牌查询</span></span><br><span class="line"><span class="comment">            f. 根据分类 _ 关键词查询</span></span><br><span class="line"><span class="comment">            g. 根据品牌 _ 关键词查询</span></span><br><span class="line"><span class="comment">        无条件查询 key</span></span><br><span class="line"><span class="comment">        goods:list:currentPage_:pageSize_:catId_:brandId_:goodsName_</span></span><br><span class="line"><span class="comment">        条件查询 key</span></span><br><span class="line"><span class="comment">        goods:currentPage_:pageSize_:catId_123:brandId_:goodsName_( 根据分类查询 )</span></span><br><span class="line"><span class="comment">        goods:currentPage_:pageSize_:catId_:brandId_123:goodsName_( 根据品牌查询 )</span></span><br><span class="line"><span class="comment">        goods:currentPage_:pageSize_:catId_:brandId_:goodsName_ 华为 ( 根据关键词查询 )</span></span><br><span class="line"><span class="comment">        goods:currentPage_:pageSize_:catId_123:brandId_123:goodsName_( 根据分类 _ 品牌查询 )</span></span><br><span class="line"><span class="comment">   goods:currentPage_:pageSize_:catId_123:brandId_:goodsName_ 华为 ( 根据分 类 _ 关键词查询 )</span></span><br><span class="line"><span class="comment">   goods:currentPage_:pageSize_:catId_:brandId_123:goodsName_ 华为 ( 根据品牌 _ 关键词查询 )</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">     String goodsListKeyStrArr[]= <span class="keyword">new</span> String[]					&#123;<span class="string">"goods:pageNum_"</span>+pageNum+<span class="string">":pageSize_"</span>+pageSize+<span class="string">":"</span>,</span><br><span class="line"> <span class="string">"catId_:"</span>,<span class="string">"brandId_:"</span>,<span class="string">"goodsName_:"</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置查询参数</span></span><br><span class="line">        <span class="comment">//商品分类参数</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span>!=goods.getCatId()&amp;&amp;<span class="number">0</span>!=goods.getCatId())&#123;</span><br><span class="line">            criteria.andCatIdEqualTo(goods.getCatId());</span><br><span class="line">            goodsListKeyStrArr[<span class="number">1</span>]=<span class="string">"catId_"</span>+goods.getCatId()+<span class="string">":"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//商品品牌参数</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span>!=goods.getBrandId()&amp;&amp;<span class="number">0</span>!=goods.getBrandId())&#123;</span><br><span class="line">            criteria.andBrandIdEqualTo(goods.getBrandId());</span><br><span class="line">            goodsListKeyStrArr[<span class="number">2</span>]=<span class="string">"brandId_"</span>+goods.getBrandId()+<span class="string">":"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//模糊查询商品名称</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span>!=goods.getGoodsName()&amp;&amp;goods.getGoodsName().trim().length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            criteria.andGoodsNameLike(<span class="string">"%"</span>+goods.getGoodsName()+<span class="string">"%"</span>);</span><br><span class="line">            goodsListKeyStrArr[<span class="number">3</span>]=<span class="string">"goodsName_"</span>+goods.getGoodsName()+<span class="string">":"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//拼接存储redis库中的key</span></span><br><span class="line">        String goodsListstr=<span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(String key:goodsListKeyStrArr)&#123;</span><br><span class="line">            goodsListstr +=key;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查询redis里是否有缓存数据</span></span><br><span class="line">        String goodsListJson= redisTemplate.opsForValue().get(goodsListstr);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span>!=goodsListJson&amp;&amp;goodsListJson.length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            PageInfo&lt;Goods&gt; pageInfo= JsonUtil.jsonStr2Object(goodsListJson,PageInfo.class);</span><br><span class="line">            <span class="keyword">return</span> BaseResult.success(pageInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查询商品设置到分页对象中</span></span><br><span class="line">        List&lt;Goods&gt; goodsList=goodsMapper.selectByExample(example);</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(goodsList)&amp;&amp;goodsList.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            PageInfo&lt;Goods&gt; goodsPageInfo=<span class="keyword">new</span> PageInfo&lt;&gt;(goodsList);</span><br><span class="line">            <span class="comment">//将查询数据存在redis中</span></span><br><span class="line">            redisTemplate.opsForValue().set(goodsListstr,JsonUtil.object2JsonStr(goodsPageInfo));</span><br><span class="line">            <span class="keyword">return</span> BaseResult.success(goodsPageInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BaseResult.error();</span><br></pre></td></tr></table></figure>

<h4 id="应对缓存穿透、缓存击穿、缓存雪崩问题"><a href="#应对缓存穿透、缓存击穿、缓存雪崩问题" class="headerlink" title="应对缓存穿透、缓存击穿、缓存雪崩问题"></a>应对缓存穿透、缓存击穿、缓存雪崩问题</h4><h5 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h5><p>缓存穿透，是指<strong>查询一个数据库一定不存在的数据</strong>。正常的使用缓存流程大致是，数据查询先进行缓存查询，如果 key 不存在或者 key 已经过期，再对数据库进行查询，并把查询到的对象，放进缓存。如果数据库查询对象为空，则不放进缓存，就会每次都去查询数据 库，而每次查询都是空，每次又都不会进行缓存。假如有恶意攻击，就可以利用这个漏洞， 对数据库造成压力，甚至压垮数据库，导致所有的请求都怼到数据库上，从而数据库连接异常。 </p>
<p>解决方案:</p>
<p> (1)利用互斥锁，缓存失效的时候，先去获得锁，得到锁了，再去请求数据库。没得到<br>锁，则休眠一段时间重试 </p>
<p>(2)采用异步更新策略，无论 key 是否取到值，都直接返回。value 值中维护一个缓存 失效时间，缓存如果过期，异步起一个线程去读数据库，更新缓存。需要做缓存预热(项目启动前，先加载缓存)操作。 ——&gt;双缓存</p>
<p>(3)提供一个能迅速判断请求是否有效的拦截机制，比如，利用布隆过滤器，内部维护 一系列合法有效的 key。迅速判断出，请求所携带的 Key 是否合法有效。如果不合法，则直接返回。<br>——&gt;断言返回异常进行拦截</p>
<p> (4) 如果从数据库查询的对象为空，也放入缓存，只是设定的缓存过期时间较短，比如 设置为 60 秒</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置查不到数据的缓存为空字符串失效时间60s</span></span><br><span class="line">redisTemplate.opsForValue().set(goodsListstr,JsonUtil.object2JsonStr(<span class="keyword">new</span> PageInfo&lt;&gt;(<span class="keyword">new</span> ArrayList&lt;Goods&gt;())),<span class="number">60</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<h5 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h5><p> 缓存击穿，是指一个<strong>key 非常热点,在不停的扛着大并发</strong>，大并发集中对这一个点进行 访问，当这个 key 在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个 屏障上凿开了一个洞。做电商项目的时候，把这货就称为“爆款”。 </p>
<p>解决方案：  其实，大多数情况下这种爆款很难对数据库服务器造成压垮性的压力。达到这个级别的 公司没有几家的。所以，对主打商品都是早早的做好了准备，让缓存永不过期。即便某些商 品自己发酵成了爆款，也是直接设为永不过期就好了。 </p>
<p>(1) 从 redis 上看，确实没有设置过期时间，这就保证了，不会出现热点 key 过期问 题，也就是“物理”不过期。 </p>
<p>(2) 从功能上看，如果不过期，那不就成静态的了吗？所以我们把过期时间存在 key 对应的 value 里，如果发现要过期了，通过一个后台的异步线程进行缓存的构建，也就是 “逻辑”过期。 </p>
<h5 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h5><p>缓存雪崩，是指<strong>缓存同一时间大面积的失效</strong>，这个时候又来了一波请求，结果请求都怼 到数据库上，从而导致数据库连接异常。 产生雪崩的原因之一，比如商城马上就要到双十一零点，很快就会迎来一波抢购，这波 商品时间比较集中的放入了缓存，假设缓存一个小时。那么到了凌晨一点钟的时候，这批商 品的缓存就都过期了。而对这批商品的访问查询，都落到了数据库上，对于数据库而言，就 会产生周期性的压力波峰。 其实集中过期，倒不是非常致命，比较致命的缓存雪崩，是缓存服务器某个节点宕机或 断网。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，那么那个时候数据库 也是可以顶住压力的，无非就是对数据库产生周期性的压力而已。而缓存服务节点的宕机，<br>对数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮。 </p>
<p>解决方案： 做电商项目的时候，一般是采取不同分类商品，缓存不同周期。在同一分类中的商品， 加上一个随机因子。这样能尽可能分散缓存过期时间，而且，热门类目的商品缓存时间长一 些，冷门类目的商品缓存时间短一些，也能节省缓存服务的资源。 </p>
<p>(1)给缓存的失效时间，加上一个随机值，避免集体失效。<br>(2)使用互斥锁，但是该方案吞吐量明显下降了。<br>(3)双缓存。我们有两个缓存，缓存 A 和缓存 B。缓存 A 的失效时间为 20 分钟，缓存 B 不设失效时间。自己做缓存预热操作。然后细分以下几个小点</p>
<p> a. 从缓存 A 读数据库，有则直接返回<br> b. A 没有数据，直接从 B 读数据，直接返回，并且异步启动一个更新线程。<br> c. 更新线程同时更新缓存 A 和缓存 B。 </p>
<h4 id="服务-远程方法调用"><a href="#服务-远程方法调用" class="headerlink" title="服务(远程方法调用)"></a>服务(远程方法调用)</h4><p>–&gt;处理重复的功能模块</p>
<blockquote>
<p>单一应用架构  </p>
</blockquote>
<blockquote>
<p>o 当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。<br>o 此时，用于简化增删改查工作量的<strong>数据访问框架(ORM)</strong>是关键。<br>o 缺点：随着应用功能的增多，代码量越来越大，越来越难维护，那怎么解决代码一体化的问题？</p>
</blockquote>
<blockquote>
<p>垂直应用架构  </p>
</blockquote>
<blockquote>
<p>o 当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。<br>o 此时，用于加速前端页面开发的<strong>Web 框架(MVC)</strong>是关键。<br>o 缺点：垂直架构中相同逻辑代码需要不断的复制，不能复用。每个垂直模 块都相当于一个独立的系统。</p>
</blockquote>
<blockquote>
<p>分布式服务架构  </p>
</blockquote>
<blockquote>
<p>o 当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多 变的市场需求。<br>o 此时，用于提高业务复用及整合的*<em>分布式服务框架(RPC) *</em>是关键。<br>o 缺点：服务越来越多，需要管理每个服务的地址，调用关系错综复杂，难 以理清依赖关系，服务状态难以管理，无法根据服务情况动态管理。 </p>
</blockquote>
<blockquote>
<p><strong>流动计算架构</strong>(当前项目应用)  </p>
</blockquote>
<blockquote>
<p>o 当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。<br>o 此时，用于提高机器利用率的*<em>资源调度和治理中心(SOA) *</em>是关键。<br>o 缺点：服务间会有依赖关系，一旦某个环节出错会影响较大，服务关系复杂，运维、测试部署困难，不符合 DevOps 思想。 </p>
</blockquote>
<blockquote>
<p>微服务架构： </p>
</blockquote>
<blockquote>
<p>o 单一职责：微服务中每一个服务都对应唯一的业务能力，做到单一职责<br>o 微：微服务的服务拆分粒度很小，例如一个用户管理就可以作为一个服 务。每个服务虽小，但“五脏俱全”。<br>o 面向服务：面向服务是说每个服务都要对外暴露服务接口 API。并不关心 服务的技术实现，做到与平台和语言无关，也不限定用什么技术实现，只 要提供 Rest 的接口即可。<br>o 自治：自治是说服务间互相独立，互不干扰 </p>
</blockquote>
<blockquote>
<p>​     团队独立：每个服务都是一个独立的开发团队，人数不能过多。<br>​     技术独立：因为是面向服务，提供 Rest 接口，使用什么技术没有 别人干涉<br>​     前后端分离：采用前后端分离开发，提供统一 Rest 接口，后端不 用再为 PC、移动端开发不同接口<br>​     数据库分离：每个服务都使用自己的数据源<br>​     部署独立，服务间虽然有调用，但要做到服务重启不影响其它服 务。有利于持续集成和持续交付。每个服务都是独立的组件，可复 用，可替换，降低耦合，易维护 Docker 部署服务 </p>
</blockquote>
<h5 id="RPC-协议"><a href="#RPC-协议" class="headerlink" title="RPC 协议"></a>RPC 协议</h5><p>(Remote Procedure Call Protocol)<br>远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底 层网络技术的协议。RPC 协议假定某些传输协议的存在，如 TCP 或 UDP，为通信程序之间 携带信息数据。在 OSI 网络通信模型中，RPC 跨越了传输层和应用层。RPC 使得开发包括网 络分布式多程序在内的应用程序更加容易。  </p>
<p>RPC 采用客户机/服务器模式。请求程序就是一个客户机，而服务提供程序就是一个服 务器。首先，客户机调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信 息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器 获得进程参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进 程接收答复信息，获得进程结果，然后调用执行继续进行。 </p>
<h6 id="RPC-与-HTTP、TCP、UDP、Socket-的区别"><a href="#RPC-与-HTTP、TCP、UDP、Socket-的区别" class="headerlink" title="RPC 与 HTTP、TCP、UDP、Socket 的区别"></a>RPC 与 HTTP、TCP、UDP、Socket 的区别</h6><p>TCP/UDP: 都是传输协议，主要区别是 tcp 协议连接需要 3 次握手，断开需要四次挥手， 是通过流来传输的，就是确定连接后，一直发送信息，传完后断开。</p>
<p>udp 不需要进行连接， 直接把信息封装成多个报文，直接发送。所以 udp 的速度更快写，但是不保证数据的完整 性。  </p>
<p>Http：超文本传输协议是一种应用层协议，建立在 TCP 协议之上  </p>
<p>Socket：是在应用程序层面上对 TCP/IP 协议的封装和应用。其实是一个调用接口，方 便程序员使用 TCP/IP 协议栈而已。程序员通过 socket 来使用 tcp/ip 协议。但是 socket 并不 是一定要使用 tcp/ip 协议，Socket 编程接口在设计的时候，就希望也能适应其他的网络协议。  </p>
<h6 id="使用RPC的理由"><a href="#使用RPC的理由" class="headerlink" title="使用RPC的理由"></a>使用RPC的理由</h6><blockquote>
<p>RPC 是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协 议。 所以 RPC 的实现可以通过不同的协议去实现比如可以使 http、RMI 等。 </p>
</blockquote>
<blockquote>
<p>论复杂度，RPC 框架肯定是高于简单的 HTTP 接口的。但毋庸置疑，HTTP 接口由于受 限于 HTTP 协议，需要带 HTTP 请求头，导致传输起来效率或者说安全性不如 RPC。 </p>
</blockquote>
<blockquote>
<p>现在问题是，遇到怎样的瓶颈了才需要或者说更适合用 RPC（比如像阿里这么大的请求 并发量，简单的 HTTP 肯定达不到预期），但问题是大家所在的公司，要有像阿里这么大的 量是比较少的，甚至说 1/1000 的量可能都没有，那我们还需要使用 RPC 吗？ </p>
</blockquote>
<blockquote>
<p>技术应该不是为了使用新技术而去使用，而应该是旧技术存在某些瓶颈，存在难以支撑 或者扩展性越老越差等问题暴露出来之后，用新技术来进行解决。 </p>
</blockquote>
<blockquote>
<p>那 RPC 最大的优点，或者说它相比简单的 HTTP 接口，它的优势、更适合它的业务场景 是怎样呢？简单的 HTTP 又哪里不足，哪些场景明显不太适合呢？ </p>
</blockquote>
<blockquote>
<p>http 接口是在接口不多、系统与系统交互较少的情况下，解决信息初期常使用的一种通 信手段；优点就是简单、直接、开发方便。利用现成的 http 协议进行传输。但是如果是一个 大型的网站，内部子系统较多、接口非常多的情况下，RPC 框架的好处就显示出来了，首先 就是长链接，不必每次通信都要像 http 一样去 3 次握手什么的，减少了网络开销(这个问题 在 http2.0 已经被解决不再算是问题了)；其次就是 RPC 框架一般都有注册中心，有丰富的 监控管理；发布、下线接口、动态扩展等，对调用方来说是无感知、统一化的操作。第三个 来说就是安全性。最后就是流行的服务化架构、服务化治理，RPC 框架是一个强力的支撑。</p>
</blockquote>
<blockquote>
<p>RPC 是一种概念，http 也是 RPC 实现的一种方式，用 http 交互其实就已经属于 RPC了。 </p>
</blockquote>
<blockquote>
<p>但是我们为什么要应用 RPC 层呢？ </p>
<p>a. 灵活部署 </p>
<p>b. 解耦 </p>
</blockquote>
<blockquote>
<p>系统做大了，肯定是需要做微服务的。 现在我们做电商就是这样，单独有一个订单系 统，支付系统，商品系统，用户系统。都是分开部署，单独上线的。  </p>
</blockquote>
<blockquote>
<p>RPC:远程过程调用。RPC 的核心并不在于使用什么协议。RPC 的目的是让你在本地调用 远程的方法，而对你来说这个调用是透明的，你并不知道这个调用的方法是部署哪里。通过 RPC 能解耦服务，这才是使用 RPC 的真正目的。RPC 的原理主要用到了动态代理模式，至 于 http 协议，只是传输协议而已。 </p>
</blockquote>
<blockquote>
<p>RPC 是一个软件结构概念，是构建分布式应用的理论基础。就好比为啥你家可以用到发 电厂发出来的电？是因为电是可以传输的。至于用铜线还是用铁丝还是其他种类的导线，也 就是用 http 还是用其他协议的问题了。这个要看什么场景，对性能要求怎么样。比如在 java 中的最基本的就是 RMI 技术，它是 java 原生的应用层分布式技术。我们可以肯定的是在传 输性能方面，RMI 的性能是优于 HTTP 的。那为啥很少用到这个技术？那是因为用这个有很 多局限性，首先它要保证传输的两端都要要用 java 实现，且两边需要有相同的对象类型和 代理接口，不需要容器，但是加大了编程的难度，在应用内部的各个子系统之间还是会看到 他的身影，比如 EJB 就是基于 rmi 技术的。这就与目前的 bs 架构的软件大相径庭。用 http 必须要服务端位于 http 容器里面，这样减少了网络传输方面的开发，只需要关注业务开发即可。</p>
</blockquote>
<h5 id="Dubbo-架构-入门demo敲一遍理解"><a href="#Dubbo-架构-入门demo敲一遍理解" class="headerlink" title="Dubbo 架构 (入门demo敲一遍理解)"></a>Dubbo 架构 (入门demo敲一遍理解)</h5><blockquote>
<p>Dubbo 是由阿里巴巴开源的一个高性能、基于 Java 开源的远程调用框架。正如在许多 RPC 系统中一样，Dubbo 是基于定义服务的概念，指定可以通过参数和返回类型远程调用 的方法。在服务器端，服务器实现这个接口，并运行一个 Dubbo 服务器来处理客户端调用。 在客户端，客户机有一个存根，它提供与服务器相同的方法。 </p>
</blockquote>
<blockquote>
<p>Dubbo 提供三个核心功能：<strong>基于接口的远程调用</strong>、<strong>容错和负载均衡</strong>，以及<strong>服务的自动注 册与发现</strong>。Dubbo 框架广泛的在阿里巴巴内部使用，以及京东、当当、去哪儿、考拉等都在 使用。</p>
</blockquote>
<blockquote>
<p>节点角色说明：<br> Provider: 暴露服务的服务提供方。<br> Consumer: 调用远程服务的服务消费方。<br> Registry: 服务注册与发现的注册中心。<br> Monitor: 统计服务的调用次调和调用时间的监控中心。<br> Container: 服务运行容器。</p>
</blockquote>
<blockquote>
<p><strong>调用关系说明</strong>(能画出来描述)：</p>
<p><img src="https://i.loli.net/2019/10/18/sKjuCpk7e5vZI6S.jpg" alt="dubbo.JPG"></p>
<p> 0. 服务容器负责启动，加载，运行服务提供者。<br> 1. 服务提供者在启动时，向注册中心注册自己提供的服务。<br> 2. 服务消费者在启动时，向注册中心订阅自己所需的服务。<br> 3. 注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于 长连接推送变更数据给消费者。<br> 4. 服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进 行调用，如果调用失败，再选另一台调用。<br> 5. 服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送 一次统计数据到监控中心。 </p>
</blockquote>
<h6 id="ZooKeeper-作为dubbo注册中心"><a href="#ZooKeeper-作为dubbo注册中心" class="headerlink" title="ZooKeeper (作为dubbo注册中心)"></a>ZooKeeper (作为dubbo注册中心)</h6><blockquote>
<p>ZooKeeper 主要的角色是当做服务注册中心存在，我们将编写好的服 务注册至 ZooKeeper 服务注册中心。 服务注册中心，给客户端提供可供调用的服务列表，客户端在进行远程服务调用时，根 据服务列表然后选择服务提供方的服务地址进行服务调用。</p>
</blockquote>
<h2 id="门户首页模块"><a href="#门户首页模块" class="headerlink" title="门户首页模块"></a>门户首页模块</h2><h3 id="查询功能"><a href="#查询功能" class="headerlink" title="查询功能"></a>查询功能</h3><p>流程:</p>
<p>(商品分类查询功能同上)<br>rpc发布商品分类查询服务<br>portal消费商品分类查询服务</p>
<h3 id="搜索功能-Elasticsearch"><a href="#搜索功能-Elasticsearch" class="headerlink" title="搜索功能(Elasticsearch )"></a>搜索功能(Elasticsearch )</h3><p>es搜索速度快的原因</p>
<p>(1.倒排索引—&gt;通过索引库里面文字出现频率位置从而产生相应的分数 ; 2.分片)</p>
<blockquote>
<p>倒排索引实现原理:</p>
<p>搜索引擎可以很方便地响应用户的查询，比如用户输入查询词“Facebook”，搜索系统查找倒排索引，从中可以读出包含这个单词的文档，这些文档就是提供给用户的搜索结果，而利用单词频率信息、文档频率信息即可以对这些候选搜索结果进行排序，计算文档和查询的相似性，按照相似性得分由高到低排序输出</p>
</blockquote>
<blockquote>
<p>分片:</p>
<p>ES中所有数据的文件块，也是<strong>数据的最小单元块</strong>，整个ES集群的核心就是对所有分片的分布、索引、负载、路由等达到惊人的速度 </p>
</blockquote>
<h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><blockquote>
<p><u>head</u><br>在学习和使用 Elasticsearch 的过程中，必不可少需要通过一些工具查看 es 的运行状态 以及数据。如果都是通过 rest 请求，未免太过麻烦，而且也不够人性化。head 可以完美帮 我们快速学习和使用 es。</p>
</blockquote>
<blockquote>
<p><u>Logstash</u><br>Logstash 是开源的服务器端数据处理管道，能够同时从多个来源采集数据，转换数据， 然后将数据发送到您最喜欢的 “存储库” 中。（我们的存储库当然是 Elasticsearch。） </p>
</blockquote>
<h6 id="使用RESTful操作资源"><a href="#使用RESTful操作资源" class="headerlink" title="==使用RESTful操作资源=="></a>==使用RESTful操作资源==</h6><ul>
<li><p><u>【GET】 /users # 查询用户信息列表</u></p>
</li>
<li><p><u>【GET】 /users/1001 # 查看某个用户信息</u></p>
</li>
<li><p><u>【POST】 /users # 新建用户信息</u></p>
</li>
<li><p><u>【PUT】 /users/1001 # 更新用户信息(全部字段)</u></p>
</li>
<li><p><u>【PATCH】 /users/1001 # 更新用户信息(部分字段)</u></p>
</li>
<li><p><u>【DELETE】 /users/1001 # 删除用户信息</u></p>
</li>
</ul>
<h6 id="ES-的搜索类型"><a href="#ES-的搜索类型" class="headerlink" title="ES 的搜索类型"></a>ES 的搜索类型</h6><ul>
<li><p>QUERY_AND_FETCH (速度最快)(返回 N 倍数据量) 向索引的所有分片（shard）都发出 查询请求，各分片返回的时候把元素文档（document）和计算后的排名信息一起返回。 这种搜索方式是最快的。</p>
</li>
<li><p>QUERY_THEN_FETCH（默认的搜索方式）这种搜索方式，</p>
<p>大概分两个步骤，第一步，先向所有的 shard 发出请 求，各分片只返回排序和排名相关的信息（注意，不包括文档 document)，然后按照各 分片返回的分数进行重新排序和排名，取前 size 个文档。然后进行第二步，去相关的 shard 取 document。这种方式返回的 document 与用户要求的 size 是相等的。 </p>
</li>
<li><p>DFS_QUERY_AND_FETCH (可以更精确控制搜索打分和排名。) </p>
</li>
<li><p>DFS_QUERY_THEN_FETCH（最慢）初始化散发其实就是在进行真正的查询之前，先把各 个分片的词频率和文档频率收集一下，然后进行词搜索的时候，各分片依据全局的词频 率和文档频率进行搜索和排名。</p>
<ul>
<li><u>总结</u>，从性能考虑 QUERY_AND_FETCH 是最快的， DFS_QUERY_THEN_FETCH 是 最慢的。从搜索的准确度来说，DFS 要比非 DFS 的准确度更高。 </li>
</ul>
</li>
</ul>
<p>ES查询–javaApi</p>
<p>———SpringDataElasticsearch整合环境 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 单条查询</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuery01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 搜索数据</span></span><br><span class="line">       GetResponse response = client.prepareGet(<span class="string">"ego"</span>, <span class="string">"goods"</span>, <span class="string">"1"</span>).execute().actionGet();</span><br><span class="line">       <span class="comment">// 输出结果</span></span><br><span class="line">       System.out.println(response.getSource());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 匹配查询</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuery02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 指定查询的索引库和类型</span></span><br><span class="line">       SearchRequestBuilder builder = client.prepareSearch(<span class="string">"ego"</span>, <span class="string">"ik"</span>)</span><br><span class="line">               .setTypes(<span class="string">"goods"</span>, <span class="string">"ikType"</span>);</span><br><span class="line">       <span class="comment">// 设置查询的关键词</span></span><br><span class="line">       String key = <span class="string">"中国"</span>;</span><br><span class="line">       <span class="comment">// 指定查询的列</span></span><br><span class="line">       builder.setQuery(QueryBuilders.multiMatchQuery(key, <span class="string">"goodsName"</span>, <span class="string">"content"</span>));</span><br><span class="line">       <span class="comment">// 开始查询</span></span><br><span class="line">       SearchResponse response = builder.get();</span><br><span class="line">       <span class="comment">// 获取命中数据</span></span><br><span class="line">       SearchHits searchHits = response.getHits();</span><br><span class="line">       <span class="comment">// 获取命中数据总条数</span></span><br><span class="line">       System.out.println(<span class="string">"查询结果总条数："</span> + searchHits.getTotalHits());</span><br><span class="line">       <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">           System.out.println(<span class="string">"索引库："</span> + hit.getIndex());</span><br><span class="line">           System.out.println(<span class="string">"类型："</span> + hit.getType());</span><br><span class="line">           System.out.println(<span class="string">"主键："</span> + hit.getId());</span><br><span class="line">           System.out.println(<span class="string">"分数："</span> + hit.getScore());</span><br><span class="line">           <span class="comment">// 命中数据</span></span><br><span class="line">           Map&lt;String, Object&gt; sourceMap = hit.getSource();</span><br><span class="line">           <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; source : sourceMap.entrySet()) &#123;</span><br><span class="line">               System.out.println(source.getKey() + <span class="string">"---"</span> + source.getValue());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 命中数据直接转 JSON</span></span><br><span class="line">           System.out.println(hit.getSourceAsString());</span><br><span class="line">           System.out.println(<span class="string">"---------------分割线---------------"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询所有</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 指定查询的索引库和类型</span></span><br><span class="line">       SearchRequestBuilder builder = client.prepareSearch(<span class="string">"ego"</span>, <span class="string">"ik"</span>)</span><br><span class="line">               .setTypes(<span class="string">"goods"</span>, <span class="string">"ikType"</span>);</span><br><span class="line">       <span class="comment">// 查询所有数据</span></span><br><span class="line">       builder.setQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">       <span class="comment">// 开始查询</span></span><br><span class="line">       SearchResponse response = builder.get();</span><br><span class="line">       <span class="comment">// 获取命中数据</span></span><br><span class="line">       SearchHits searchHits = response.getHits();</span><br><span class="line">       <span class="comment">// 获取命中数据总条数</span></span><br><span class="line">       System.out.println(<span class="string">"查询结果总条数："</span> + searchHits.getTotalHits());</span><br><span class="line">       <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">           System.out.println(<span class="string">"索引库："</span> + hit.getIndex());</span><br><span class="line">           System.out.println(<span class="string">"类型："</span> + hit.getType());</span><br><span class="line">           System.out.println(<span class="string">"主键："</span> + hit.getId());</span><br><span class="line">           System.out.println(<span class="string">"分数："</span> + hit.getScore());</span><br><span class="line">           <span class="comment">// 命中数据</span></span><br><span class="line">           Map&lt;String, Object&gt; sourceMap = hit.getSource();</span><br><span class="line">           <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; source : sourceMap.entrySet()) &#123;</span><br><span class="line">               System.out.println(source.getKey() + <span class="string">"---"</span> + source.getValue());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 命中数据直接转 JSON</span></span><br><span class="line">           System.out.println(hit.getSourceAsString());</span><br><span class="line">           System.out.println(<span class="string">"---------------分割线---------------"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 分页查询</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       queryPage(<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">queryPage</span><span class="params">(Integer pageNum, Integer pageSize)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 指定查询的索引库和类型</span></span><br><span class="line">       SearchRequestBuilder builder = client.prepareSearch(<span class="string">"ego"</span>).setTypes(<span class="string">"goods"</span>);</span><br><span class="line">       <span class="comment">// 设置分页</span></span><br><span class="line">       builder.setFrom((pageNum - <span class="number">1</span>) * pageSize).setSize(pageSize);</span><br><span class="line">       <span class="comment">// 设置查询的关键词</span></span><br><span class="line">       String key = <span class="string">"中国移动联通电信"</span>;</span><br><span class="line">       <span class="comment">// 指定查询的列</span></span><br><span class="line">       builder.setQuery(QueryBuilders.multiMatchQuery(key, <span class="string">"goodsName"</span>));</span><br><span class="line">       <span class="comment">// 开始查询</span></span><br><span class="line">       SearchResponse response = builder.get();</span><br><span class="line">       <span class="comment">// 获取命中数据</span></span><br><span class="line">       SearchHits searchHits = response.getHits();</span><br><span class="line">       <span class="comment">// 获取命中数据总条数</span></span><br><span class="line">       System.out.println(<span class="string">"查询结果总条数："</span> + searchHits.getTotalHits());</span><br><span class="line">       <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">           System.out.println(<span class="string">"索引库："</span> + hit.getIndex());</span><br><span class="line">           System.out.println(<span class="string">"类型："</span> + hit.getType());</span><br><span class="line">           System.out.println(<span class="string">"主键："</span> + hit.getId());</span><br><span class="line">           System.out.println(<span class="string">"分数："</span> + hit.getScore());</span><br><span class="line">           <span class="comment">// 命中数据</span></span><br><span class="line">           Map&lt;String, Object&gt; sourceMap = hit.getSource();</span><br><span class="line">           <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; source : sourceMap.entrySet()) &#123;</span><br><span class="line">               System.out.println(source.getKey() + <span class="string">"---"</span> + source.getValue());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 命中数据直接转 JSON</span></span><br><span class="line">           System.out.println(hit.getSourceAsString());</span><br><span class="line">           System.out.println(<span class="string">"---------------分割线---------------"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 高亮查询</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryPageHl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 指定查询的索引库和类型</span></span><br><span class="line">       SearchRequestBuilder builder = client.prepareSearch(<span class="string">"ego"</span>).setTypes(<span class="string">"goods"</span>);</span><br><span class="line">       <span class="comment">// 设置分页</span></span><br><span class="line">       builder.setFrom(<span class="number">0</span>).setSize(<span class="number">5</span>);</span><br><span class="line">       <span class="comment">// 设置高亮前缀</span></span><br><span class="line">       builder.setHighlighterPreTags(<span class="string">"&lt;span style='color:red;'&gt;"</span>);</span><br><span class="line">       <span class="comment">// 设置高亮后缀</span></span><br><span class="line">       builder.setHighlighterPostTags(<span class="string">"&lt;/span&gt;"</span>);</span><br><span class="line">       <span class="comment">// 设置高亮字段名称</span></span><br><span class="line">       builder.addHighlightedField(<span class="string">"goodsName"</span>);</span><br><span class="line">       <span class="comment">// 设置查询的关键词</span></span><br><span class="line">       String key = <span class="string">"中国移动联通电信"</span>;</span><br><span class="line">       <span class="comment">// 指定查询的列</span></span><br><span class="line">       builder.setQuery(QueryBuilders.multiMatchQuery(key, <span class="string">"goodsName"</span>));</span><br><span class="line">       <span class="comment">// 开始查询</span></span><br><span class="line">       SearchResponse response = builder.get();</span><br><span class="line">       <span class="comment">// 获取命中数据</span></span><br><span class="line">       SearchHits searchHits = response.getHits();</span><br><span class="line">       <span class="comment">// 获取命中数据总条数</span></span><br><span class="line">       System.out.println(<span class="string">"查询结果总条数："</span> + searchHits.getTotalHits());</span><br><span class="line">       <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">           <span class="comment">// 构建项目中所需的数据结果集</span></span><br><span class="line">           String highlightMessage = String.valueOf(hit.getHighlightFields().get(<span class="string">"goodsName"</span>).fragments()[<span class="number">0</span>]);</span><br><span class="line">           Integer goodsId = (Integer) hit.getSource().get(<span class="string">"goodsId"</span>);</span><br><span class="line">           String goodsName = String.valueOf(hit.getSource().get(<span class="string">"goodsName"</span>));</span><br><span class="line">           String originalImg = String.valueOf(hit.getSource().get(<span class="string">"originalImg"</span>));</span><br><span class="line">           BigDecimal marketPrice = <span class="keyword">new</span> BigDecimal(String.valueOf(hit.getSource().get(<span class="string">"marketPrice"</span>)));</span><br><span class="line"></span><br><span class="line">           System.out.println(<span class="string">"goodsId: "</span> + goodsId);</span><br><span class="line">           System.out.println(<span class="string">"goodsName: "</span> + goodsName);</span><br><span class="line">           System.out.println(<span class="string">"goodsNameHl: "</span> + highlightMessage);</span><br><span class="line">           System.out.println(<span class="string">"marketPrice: "</span> + marketPrice);</span><br><span class="line">           System.out.println(<span class="string">"originalImg: "</span> + originalImg);</span><br><span class="line">           System.out.println(<span class="string">"---------------分割线---------------"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchServiceImpl</span> <span class="keyword">implements</span> <span class="title">SearchServiceI</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TransportClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品搜索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GoodsVo&gt; <span class="title">doSearch</span><span class="params">(String searchStr, Integer pageNum, Integer pageSize)</span> </span>&#123;</span><br><span class="line">        SearchRequestBuilder builder = client.prepareSearch(<span class="string">"ego"</span>).setTypes(<span class="string">"goods"</span>);</span><br><span class="line">        <span class="comment">//设置分页</span></span><br><span class="line">        builder.setFrom((pageNum - <span class="number">1</span>) * pageSize).setSize(pageSize);</span><br><span class="line">        <span class="comment">//设置高亮前缀</span></span><br><span class="line">        builder.setHighlighterPreTags(<span class="string">"&lt;span style='color:yellow;'&gt;"</span>);</span><br><span class="line">        builder.setHighlighterPostTags(<span class="string">"&lt;/span&gt;"</span>);</span><br><span class="line">        <span class="comment">//设置高亮字段</span></span><br><span class="line">        builder.addHighlightedField(<span class="string">"goodsName"</span>);</span><br><span class="line">        <span class="comment">//通过商品名查询</span></span><br><span class="line">        builder.setQuery(QueryBuilders.multiMatchQuery(searchStr, <span class="string">"goodsName"</span>));</span><br><span class="line">        <span class="comment">//查询</span></span><br><span class="line">        SearchResponse response = builder.get();</span><br><span class="line">        <span class="comment">//获取命中数据</span></span><br><span class="line">        SearchHits hits = response.getHits();</span><br><span class="line">        <span class="comment">//循环遍历命中数据</span></span><br><span class="line">        List&lt;GoodsVo&gt; goodsVoList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit searchHit : hits) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> &gt;= hits.getHits().length)</span><br><span class="line">                <span class="keyword">return</span> goodsVoList;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 查询高亮数据</span></span><br><span class="line">                String highLightMessage = searchHit.getHighlightFields().get(<span class="string">"goodsName"</span>).fragments()[<span class="number">0</span>].toString();</span><br><span class="line">                <span class="comment">// 初始化高亮对象</span></span><br><span class="line">                GoodsVo goodsVo = <span class="keyword">new</span> GoodsVo();</span><br><span class="line">                goodsVo.setGoodsId(Integer.parseInt(searchHit.getId()));</span><br><span class="line">                goodsVo.setGoodsName(highLightMessage);</span><br><span class="line">                goodsVo.setMarketPrice(<span class="keyword">new</span> BigDecimal(String.valueOf(searchHit.getSource().get(<span class="string">"marketPrice"</span>))));</span><br><span class="line">                goodsVo.setOriginalImg(String.valueOf(searchHit.getSource().get(<span class="string">"originalImg"</span>)));</span><br><span class="line">                <span class="comment">// 添加至集合</span></span><br><span class="line">                goodsVoList.add(goodsVo);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> goodsVoList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h4><p>发布搜索服务,门户消费搜索服务,将查询到的搜索信息存到pageinfo中,页面处理dot模板和分页</p>
<h3 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a>单点登录</h3><blockquote>
<ul>
<li><p>定义–&gt;SSO 的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任 的应用系统。 </p>
</li>
<li><p>实现机制</p>
<p>当用户第一次访问应用系统的时候，因为还没有登录，会被引导到认证系统中进行登录； 根据用户提供的登录信息，认证系统进行身份校验，如果通过校验，应该返回给用户一个认 证的凭据——ticket；用户再访问别的应用的时候，就会将这个 ticket 带上，作为自己认 证的凭据，应用系统接受到请求之后会把 ticket 送到认证系统进行校验，检查 ticket 的 合法性。如果通过校验，用户就可以在不用再次登录的情况下访问应用系统 2 和应用系统 3 了。 </p>
<p>要实现 SSO，需要以下主要的功能： </p>
<pre><code>a. 所有应用系统共享一个身份认证系统。 
b. 统一的认证系统是 SSO 的前提之一。认证系统的主要功能是将用户的登录信息和用户信息库相比较，对用户进行登录认证；认证成功后，认证系统应该生成统一的认证标志 （ticket），返还给用户。另外，认证系统还应该对ticket进行效验，判断其有效性。所 有应用系统能够识别和提取 ticket 信息。
c. 要实现 SSO 的功能，让用户只登录一次，就必须让应用系统能够识别已经登录过的用户。应用系统应该能对 ticket 进行识别和提取，通过与认证系统的通讯，能自动判断当前用户是否登录过，从而完成单点登录的功能。 </code></pre><p><img src="https://i.loli.net/2019/10/23/yV1EBqMHvL6brzj.jpg" alt="sso.JPG"></p>
</li>
</ul>
</blockquote>
<h4 id="实现思路-1"><a href="#实现思路-1" class="headerlink" title="实现思路"></a>实现思路</h4><ul>
<li>登录功能主要实现</li>
</ul>
<ol>
<li><p>登录认证方法返回登录校验收据的信息</p>
<p>通过用户名密码验证用户信息，如果用户信息唯一返回票据 </p>
<p>根据用户名查询用户信息 </p>
<p>用户名和密码一致，登录成功返回票据信息 </p>
<p> 生成票据信息存入 redis ，页面借助 cookie存储票据的 key </p>
</li>
<li><p>验证校验信息返回用户对象</p>
</li>
</ol>
<ul>
<li><p>拦截器实现思路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求处理的方法之前执行  </span></span><br><span class="line"><span class="comment">// 如果返回 true ，执行下一个拦截器或目标程序，如果返回 false ，不执行下一个拦截器或目标程序</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li><p>获取用户登录收据</p>
</li>
<li><p>判断收据是否存在,不存在返回登录界面</p>
<p>存在进行验证</p>
<p>验证成功,将用户信息存在session中,重设收据失效时间</p>
</li>
</ol>
<ul>
<li><p>安全退出功能</p>
<ol>
<li>根据票据信息查询用户信息</li>
<li>票据存在用户信息，清除用户信息<ul>
<li>获取ticket</li>
<li>清除redis cookie session</li>
</ul>
</li>
</ol>
<ul>
<li>前台后台同理 不同在于登录认证不存在或者用户不存在时用户还是可以访问门户网站只清除session</li>
</ul>
</li>
</ul>
<p>(!!!极验实现验证码)</p>
<h3 id="购物车功能"><a href="#购物车功能" class="headerlink" title="购物车功能"></a>购物车功能</h3><p>技术选择redis存储原因</p>
<blockquote>
<p>a. cookie + session，不能跨客户端，不能跨平台。<br>b. 数据库，能跨客户端，能跨平台，性能比较低。<br>c. redis，能跨客户端，能跨平台，性能优秀。</p>
</blockquote>
<p>功能实现思路:</p>
<p>通过hash来存储购物车信息——&gt;</p>
<p>redis的key用户主键|hash的key商品主键|value购买商品的信息</p>
<ul>
<li>添加购物车<ul>
<li>判断用户是否存在,不存在直接返回</li>
<li>用户存在获取用户id,通过用户id查询该用户购物车信息</li>
<li>购物车信息为空,添加购物车</li>
<li>购物车信息非空并存在商品,修改购物车商品信息;商品不存在则新增购物车</li>
<li>将信息存进redis</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> BaseResult <span class="title">addToCart</span><span class="params">(CartVo cartVo, Admin admin)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == admin || <span class="keyword">null</span> == admin.getAdminId())</span><br><span class="line">           <span class="keyword">return</span> BaseResult.error();</span><br><span class="line"></span><br><span class="line">       cartVo.setAddTime(<span class="keyword">new</span> Date());</span><br><span class="line">       HashOperations&lt;String, String, String&gt; hashOperations = redisTemplate.opsForHash();</span><br><span class="line">       <span class="comment">// 根据用户获取购物车信息</span></span><br><span class="line">       Map&lt;String, String&gt; cartVoMap = hashOperations.entries(userCart + admin.getAdminId());</span><br><span class="line">       <span class="comment">// 判断购物车是否为空</span></span><br><span class="line">       <span class="keyword">if</span> (CollectionUtils.isEmpty(cartVoMap) || cartVoMap.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// 购物车为空，添加</span></span><br><span class="line">           putCartVo(hashOperations, admin, cartVo);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 购物车不为空，判断购物车中是否存在添加的商品</span></span><br><span class="line">           String cartVoJson = cartVoMap.get(String.valueOf(cartVo.getGoodsId()));</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> == cartVoJson || cartVoJson.length() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="comment">// 不存在要添加的商品</span></span><br><span class="line">               putCartVo(hashOperations, admin, cartVo);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 添加的商品已存在，修改数量(累加)和价格(重新覆盖)</span></span><br><span class="line">               CartVo cv = JsonUtil.jsonStr2Object(cartVoJson, CartVo.class);</span><br><span class="line">               cv.setGoodsNum(cv.getGoodsNum() + cartVo.getGoodsNum());</span><br><span class="line">               cv.setMarketPrice(cartVo.getMarketPrice());</span><br><span class="line">               <span class="comment">// 重新添加至redis</span></span><br><span class="line">               putCartVo(hashOperations, admin, cv);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> BaseResult.success();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 添加商品至购物车</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putCartVo</span><span class="params">(HashOperations&lt;String, String, String&gt; hashOperations,</span></span></span><br><span class="line"><span class="function"><span class="params">                          Admin admin, CartVo cartVo)</span> </span>&#123;</span><br><span class="line">       hashOperations.put(userCart + admin.getAdminId(),</span><br><span class="line">               String.valueOf(cartVo.getGoodsId()), JsonUtil.object2JsonStr(cartVo));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取购物车数量<ul>
<li>判断用户是否存在,不存在直接返回</li>
<li>查询用户购物车信息</li>
<li>购物车信息不为空,遍历map,累加商品数量</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取购物车数量</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> admin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCartNum</span><span class="params">(Admin admin)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == admin || <span class="keyword">null</span> == admin.getAdminId())</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        HashOperations&lt;String, String, String&gt; hashOperations = redisTemplate.opsForHash();</span><br><span class="line">        <span class="comment">// 根据用户获取购物车信息</span></span><br><span class="line">        Map&lt;String, String&gt; cartVoMap = hashOperations.entries(userCart + admin.getAdminId());</span><br><span class="line">        <span class="comment">// 判断购物车是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(cartVoMap) || cartVoMap.size() &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 购物车不为空，循环处理返回数量</span></span><br><span class="line">        Integer total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; cartVoM : cartVoMap.entrySet()) &#123;</span><br><span class="line">            CartVo cv = JsonUtil.jsonStr2Object(cartVoM.getValue(), CartVo.class);</span><br><span class="line">            total += cv.getGoodsNum();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>查询购物车列表和总金额<ul>
<li>判断用户是否存在,不存在直接返回</li>
<li>判断购物车是否存在商品,不存在返回</li>
<li>存在商品,创建容器处理存储商品信息和总金额</li>
<li>先计算单个商品总价,遍历时累加计算出总价</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CartResult <span class="title">getCartList</span><span class="params">(Admin admin)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == admin || <span class="keyword">null</span> == admin.getAdminId())</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      HashOperations&lt;String, String, String&gt; hashOperations = redisTemplate.opsForHash();</span><br><span class="line">      <span class="comment">// 根据用户获取购物车信息</span></span><br><span class="line">      Map&lt;String, String&gt; cartVoMap = hashOperations.entries(userCart + admin.getAdminId());</span><br><span class="line">      <span class="comment">// 判断购物车是否为空</span></span><br><span class="line">      <span class="keyword">if</span> (CollectionUtils.isEmpty(cartVoMap) || cartVoMap.size() &lt;= <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// 购物车不为空，循环处理返回集合和总金额</span></span><br><span class="line">      CartResult result = <span class="keyword">new</span> CartResult();</span><br><span class="line">      BigDecimal totalPrice = <span class="keyword">new</span> BigDecimal(<span class="string">"0"</span>);</span><br><span class="line">      List&lt;CartVo&gt; cartVoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; cartVoM : cartVoMap.entrySet()) &#123;</span><br><span class="line">          CartVo cv = JsonUtil.jsonStr2Object(cartVoM.getValue(), CartVo.class);</span><br><span class="line">          <span class="comment">// 四舍五入保留两位小数，不足0补齐</span></span><br><span class="line">          String marketPriceFormat = <span class="keyword">new</span> DecimalFormat(<span class="string">"0.00"</span>).format(cv.getMarketPrice());</span><br><span class="line">          cv.setMarketPrice(<span class="keyword">new</span> BigDecimal(marketPriceFormat));</span><br><span class="line">          <span class="comment">// 计算单个商品的总价</span></span><br><span class="line">          BigDecimal singlePrice = <span class="keyword">new</span> BigDecimal(marketPriceFormat).multiply(<span class="keyword">new</span> BigDecimal(cv.getGoodsNum()));</span><br><span class="line">          <span class="comment">// 总金额累加单个商品总价</span></span><br><span class="line">          totalPrice = totalPrice.add(singlePrice);</span><br><span class="line">          cartVoList.add(cv);</span><br><span class="line">      &#125;</span><br><span class="line">      result.setCartVoList(cartVoList);</span><br><span class="line">      result.setTotalPrice(totalPrice);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>面试:购物车商品信息同步问题</p>
<p>解决方式:根据es库中商品主键查询商品信息,将最新商品信息同步到redis库中–购物车的信息通过数据库的订单来同步数据</p>
<h2 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h2><p>1 ——-&gt;</p>
<p><img src="https://i.loli.net/2019/10/23/vuhrclHkXY8yCox.jpg" alt="bugdubbo.JPG"></p>
<p>排查过程及解决办法：</p>
<blockquote>
<p>1、首先检查注册中心服务器问题，查看服务器是否正常，是否开启端口或关闭防火墙，保证端口可以 telnet（如果是测试，可以直接关闭防火墙，在生产环境中则需要开启端口策略）。<br>2、检查调用的接口路径是否错误，在参数中 interface=com.huazai.b2c.aiyou.service.TDubboService，而com.huazai.b2c.aiyou.service.TDubboService就是要远程调用的接口，检查远程或第三发服务提供商接口包路径是否一致（必须保证一致）。<br>3、检查或通知第三发服务提供商其服务器是否运行正常（必须正常，否则无法正常提供数据）。</p>
<p>from net</p>
</blockquote>
<p>问题:未发布服务,消费不存在的服务</p>
<p>2 ——-&gt;</p>
<p><strong>logstash启动报配置文件错误Expected one of #, input, filter, output at line 1, column 1 (byte 1) after</strong></p>
<blockquote>
<p>解决方案：文件编码格式问题导致第一行有隐藏文件头，改为UTF-8无BOM模式（也就是UTF-8模式就行）。 </p>
</blockquote>
<p>3 ——-&gt;</p>
<p><strong>error 503 service unavailable</strong> 服务不可用的一种状态 </p>
<p>4 ——-&gt;</p>
<p><strong>403 Access Denied</strong> 没有权限访问此站 (配置文件错误)</p>
<p>5 ——-&gt;</p>
<p> <strong>Error:Illegal char &lt;:&gt; at index 4</strong> (//记不清 好像运行环境和编译环境不一致)</p>
<p>6 ——-&gt;</p>
<p><strong>找不到org.springframework.beans.factory.BeanNameAware的类文件</strong>(pom.xml引进坐标问题)</p>
<p>7 ——-&gt;</p>
<p><strong>dubbo发布服务失败问题</strong>(//配置文件错误)</p>
<p>8 ——-&gt;</p>
<p><strong>implements HandlerInterceptor</strong>拦截器用该方式,导致后台运行成功前台无法跳转到主页</p>
<p>处理方式:当前台取到后台json字符串正确时,拦截器中cookiename取错值取了配置文件里面的存在redis的key导致无法运行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取用户票据</span></span><br><span class="line">String cookieValue = CookieUtil.getCookieValue(request, <span class="string">"userTicket"</span>);</span><br></pre></td></tr></table></figure>

<p>9 ——-&gt;</p>
<p><strong>IDEA运行时出现端口号被占用，但不知道是哪里在用时的解决办法</strong></p>
<p>解决方法: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -aon|findstr 端口号</span><br><span class="line">taskkill /f /pid</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/11/redis/" rel="next" title="redis">
                <i class="fa fa-chevron-left"></i> redis
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/mengkai.jpg" alt="Meng Kai">
            
              <p class="site-author-name" itemprop="name">Meng Kai</p>
              <p class="site-description motion-element" itemprop="description">孟凯个人站 coding basketball</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
          <div id="music163player">
         <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=415786851&auto=1&height=66"></iframe>
         </div>

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基于ssm的电商系统"><span class="nav-number">1.</span> <span class="nav-text">基于ssm的电商系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#商品模块"><span class="nav-number">1.1.</span> <span class="nav-text">商品模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#产品分类添加"><span class="nav-number">1.1.1.</span> <span class="nav-text">产品分类添加</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#文件上传"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">文件上传</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#产品分类查询"><span class="nav-number">1.1.2.</span> <span class="nav-text">产品分类查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#产品添加"><span class="nav-number">1.1.3.</span> <span class="nav-text">产品添加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#商品分页查询"><span class="nav-number">1.1.4.</span> <span class="nav-text">商品分页查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#redis"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">redis</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#操作-redis-五种数据类型"><span class="nav-number">1.1.4.1.1.</span> <span class="nav-text">操作 redis 五种数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#操作-String"><span class="nav-number">1.1.4.1.1.1.</span> <span class="nav-text">操作 String **</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#操作-hash"><span class="nav-number">1.1.4.1.1.2.</span> <span class="nav-text">操作 hash **</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#操作-list"><span class="nav-number">1.1.4.1.1.3.</span> <span class="nav-text">操作 list</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#操作-set"><span class="nav-number">1.1.4.1.1.4.</span> <span class="nav-text">操作 set</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#操作-sorted-set"><span class="nav-number">1.1.4.1.1.5.</span> <span class="nav-text">操作 sorted set</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Redis-中以层级关系、目录形式存储数据"><span class="nav-number">1.1.4.1.2.</span> <span class="nav-text">Redis 中以层级关系、目录形式存储数据 **</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#设置-key-的失效时间"><span class="nav-number">1.1.4.1.3.</span> <span class="nav-text">设置 key 的失效时间</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#删除"><span class="nav-number">1.1.4.1.3.1.</span> <span class="nav-text">删除</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#jedis"><span class="nav-number">1.1.4.1.4.</span> <span class="nav-text">jedis</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#jedis-API"><span class="nav-number">1.1.4.1.4.1.</span> <span class="nav-text">jedis API</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Redis-持久化"><span class="nav-number">1.1.4.1.5.</span> <span class="nav-text">Redis 持久化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Redis-搭建主从复用-读写分离"><span class="nav-number">1.1.4.1.6.</span> <span class="nav-text">Redis 搭建主从复用-读写分离</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Spring-Data-Redis-操作-Redis"><span class="nav-number">1.1.4.1.7.</span> <span class="nav-text">Spring Data Redis 操作 Redis</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用redis实现缓存-商品分类以及商品列表"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">使用redis实现缓存(商品分类以及商品列表)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#应对缓存穿透、缓存击穿、缓存雪崩问题"><span class="nav-number">1.1.4.3.</span> <span class="nav-text">应对缓存穿透、缓存击穿、缓存雪崩问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#缓存穿透"><span class="nav-number">1.1.4.3.1.</span> <span class="nav-text">缓存穿透</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#缓存击穿"><span class="nav-number">1.1.4.3.2.</span> <span class="nav-text">缓存击穿</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#缓存雪崩"><span class="nav-number">1.1.4.3.3.</span> <span class="nav-text">缓存雪崩</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务-远程方法调用"><span class="nav-number">1.1.4.4.</span> <span class="nav-text">服务(远程方法调用)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RPC-协议"><span class="nav-number">1.1.4.4.1.</span> <span class="nav-text">RPC 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#RPC-与-HTTP、TCP、UDP、Socket-的区别"><span class="nav-number">1.1.4.4.1.1.</span> <span class="nav-text">RPC 与 HTTP、TCP、UDP、Socket 的区别</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#使用RPC的理由"><span class="nav-number">1.1.4.4.1.2.</span> <span class="nav-text">使用RPC的理由</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dubbo-架构-入门demo敲一遍理解"><span class="nav-number">1.1.4.4.2.</span> <span class="nav-text">Dubbo 架构 (入门demo敲一遍理解)</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ZooKeeper-作为dubbo注册中心"><span class="nav-number">1.1.4.4.2.1.</span> <span class="nav-text">ZooKeeper (作为dubbo注册中心)</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#门户首页模块"><span class="nav-number">1.2.</span> <span class="nav-text">门户首页模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询功能"><span class="nav-number">1.2.1.</span> <span class="nav-text">查询功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搜索功能-Elasticsearch"><span class="nav-number">1.2.2.</span> <span class="nav-text">搜索功能(Elasticsearch )</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#工具"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">工具</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#使用RESTful操作资源"><span class="nav-number">1.2.2.1.0.1.</span> <span class="nav-text">==使用RESTful操作资源==</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ES-的搜索类型"><span class="nav-number">1.2.2.1.0.2.</span> <span class="nav-text">ES 的搜索类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现思路"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">实现思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单点登录"><span class="nav-number">1.2.3.</span> <span class="nav-text">单点登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现思路-1"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">实现思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#购物车功能"><span class="nav-number">1.2.4.</span> <span class="nav-text">购物车功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bug"><span class="nav-number">1.3.</span> <span class="nav-text">bug</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Meng Kai</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
